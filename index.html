<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Visualizer Pro - Cinema Edition</title>
    <style>
        :root { --accent: #00f2ff; --bg: #050505; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        
        body, html { 
            margin: 0; padding: 0; width: 100%; height: 100%; 
            background: var(--bg); overflow: hidden; font-family: 'Inter', -apple-system, sans-serif;
            touch-action: none; color: white;
        }
        
        canvas { position: absolute; top: 0; left: 0; display: block; width: 100%; height: 100%; cursor: none; }

        /* UI-Leiste: Standardmäßig unsichtbar im Fokus */
        .ui-layer {
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
            display: flex; flex-wrap: wrap; justify-content: center; gap: 8px; 
            z-index: 1000; background: rgba(10, 10, 10, 0.85); padding: 15px; 
            border-radius: 12px; backdrop-filter: blur(25px);
            width: 90%; max-width: 800px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: opacity 0.6s cubic-bezier(0.4, 0, 0.2, 1), transform 0.6s ease;
            opacity: 0; pointer-events: none;
        }

        /* Nur anzeigen, wenn .show-ui aktiv ist */
        body.show-ui .ui-layer { opacity: 1; pointer-events: auto; transform: translate(-50%, 0); }
        body.is-fullscreen .ui-layer { bottom: 20px; }

        button {
            background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(255,255,255,0.05); color: #888;
            padding: 10px 14px; border-radius: 6px; cursor: pointer; 
            font-size: 11px; font-weight: 500; text-transform: uppercase; letter-spacing: 1px;
            transition: 0.3s all;
        }
        button.active { background: rgba(0, 242, 255, 0.15); color: var(--accent); border-color: var(--accent); }
        button.special { border-color: #555; color: #fff; }

        #start-screen {
            position: fixed; inset: 0; background: #000; z-index: 2000;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        .start-btn {
            background: none; border: 1px solid var(--accent); color: var(--accent);
            padding: 15px 40px; border-radius: 2px; font-size: 16px; letter-spacing: 4px;
            cursor: pointer; transition: 0.4s;
        }
        .start-btn:hover { background: var(--accent); color: #000; }
    </style>
</head>
<body class="show-ui"> <div id="start-screen">
        <h1 style="letter-spacing: 20px; font-weight: 100; margin-bottom: 40px; opacity: 0.7;">V I Z</h1>
        <button class="start-btn" onclick="initApp()">ENTER</button>
    </div>

    <canvas id="canvas"></canvas>

    <div class="ui-layer" id="controls">
        <button onclick="setMode(0)">Minimalist</button>
        <button onclick="setMode(1)">Particles</button>
        <button onclick="setMode(2)">Horizon</button>
        <button onclick="setMode(3)">Geometric</button>
        <button onclick="setMode(4)">String</button>
        <button onclick="setMode(5)">Tunnel</button>
        <button onclick="toggleFilmMode()" id="film-btn" class="special">Film Mode</button>
        <button onclick="toggleFS()" class="special">Fullscreen</button>
    </div>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        let audioCtx, analyser, dataArray, source, wakeLock = null;
        let mode = 0, hue = 190, uiTimeout, isFilmMode = false;

        function resize() {
            canvas.width = window.innerWidth * window.devicePixelRatio;
            canvas.height = window.innerHeight * window.devicePixelRatio;
            ctx.scale(window.devicePixelRatio, window.devicePixelRatio);
        }
        window.addEventListener('resize', resize);
        resize();

        async function initApp() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    audio: { echoCancellation: false, noiseSuppression: false, autoGainControl: false } 
                });
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                source = audioCtx.createMediaStreamSource(stream);
                analyser = audioCtx.createAnalyser();
                analyser.fftSize = 512;
                analyser.smoothingTimeConstant = 0.88;
                dataArray = new Uint8Array(analyser.frequencyBinCount);
                source.connect(analyser);
                
                if ('wakeLock' in navigator) wakeLock = await navigator.wakeLock.request('screen');
                
                document.getElementById('start-screen').style.display = 'none';
                hideUI(); 
                draw();
            } catch (err) { alert("Mikrofon Zugriff verweigert."); }
        }

        function setMode(m) {
            mode = m;
            isFilmMode = false;
            updateUI();
        }

        function toggleFilmMode() {
            isFilmMode = !isFilmMode;
            updateUI();
        }

        function updateUI() {
            const btns = document.querySelectorAll('button');
            btns.forEach((btn, i) => {
                btn.classList.toggle('active', mode === i && !isFilmMode);
            });
            document.getElementById('film-btn').classList.toggle('active', isFilmMode);
        }

        function toggleFS() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
                document.body.classList.add('is-fullscreen');
            } else {
                document.exitFullscreen();
            }
        }

        // UI Management
        function showUI() {
            document.body.classList.add('show-ui');
            clearTimeout(uiTimeout);
            uiTimeout = setTimeout(hideUI, 2500); // UI verschwindet nach 2.5 Sek
        }
        function hideUI() { document.body.classList.remove('show-ui'); }

        window.addEventListener('pointermove', showUI);
        window.addEventListener('pointerdown', showUI);

        // Film Modus Automatismus
        setInterval(() => {
            if(isFilmMode) {
                mode = (mode + 1) % 6;
                updateUI();
            }
        }, 15000);

        function draw() {
            requestAnimationFrame(draw);
            analyser.getByteFrequencyData(dataArray);
            
            const w = window.innerWidth, h = window.innerHeight, cx = w/2, cy = h/2;
            
            // Edler Fade-Effekt (Trails)
            ctx.fillStyle = 'rgba(5, 5, 5, 0.15)';
            ctx.fillRect(0, 0, w, h);
            
            const bass = dataArray[2] / 255;
            ctx.shadowBlur = bass * 25; // Dynamischer Glow basierend auf Bass
            ctx.shadowColor = `hsla(${hue}, 100%, 50%, 0.5)`;

            switch(mode) {
                case 0: drawMinimalist(w, h, cx, cy); break;
                case 1: drawParticles(w, h, cx, cy); break;
                case 2: drawHorizon(w, h, cx, cy); break;
                case 3: drawGeometric(w, h, cx, cy); break;
                case 4: drawString(w, h, cx, cy); break;
                case 5: drawTunnel(w, h, cx, cy); break;
            }
        }

        // --- Professionelle Modi ---

        function drawMinimalist(w, h, cx, cy) {
            const count = 40;
            const step = w / count;
            for(let i=0; i<count; i++) {
                const val = (dataArray[i*2]/255) * h * 0.4;
                ctx.fillStyle = `rgba(0, 242, 255, ${0.1 + (val/h)})`;
                ctx.fillRect(i * step, h/2 - val/2, step - 4, val);
            }
        }

        function drawParticles(w, h, cx, cy) {
            for(let i=0; i<60; i++) {
                const val = dataArray[i*2] / 255;
                const x = (i/60) * w;
                const y = cy + Math.sin(Date.now()*0.002 + i) * 50;
                ctx.fillStyle = `rgba(0, 242, 255, ${val})`;
                ctx.beginPath();
                ctx.arc(x, y - val*100, val*4 + 1, 0, Math.PI*2);
                ctx.fill();
            }
        }

        function drawHorizon(w, h, cx, cy) {
            ctx.beginPath();
            ctx.strokeStyle = varColor(0.8);
            ctx.lineWidth = 2;
            for(let i=0; i<dataArray.length; i+=4) {
                const x = (i/dataArray.length) * w;
                const y = cy - (dataArray[i]/255) * 150;
                if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
            }
            ctx.stroke();
            // Spiegelung
            ctx.beginPath();
            ctx.strokeStyle = varColor(0.2);
            for(let i=0; i<dataArray.length; i+=4) {
                const x = (i/dataArray.length) * w;
                const y = cy + (dataArray[i]/255) * 100;
                if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
            }
            ctx.stroke();
        }

        function drawGeometric(w, h, cx, cy) {
            ctx.translate(cx, cy);
            ctx.rotate(Date.now() * 0.0005);
            for(let i=0; i<12; i++) {
                const val = dataArray[i*10] * 0.8;
                ctx.strokeStyle = varColor(0.5);
                ctx.strokeRect(-val/2, -val/2, val, val);
                ctx.rotate(Math.PI / 6);
            }
        }

        function drawString(w, h, cx, cy) {
            ctx.beginPath();
            ctx.lineWidth = 1;
            for(let i=0; i<50; i++) {
                const val = dataArray[i] * 1.5;
                ctx.strokeStyle = varColor(0.3);
                ctx.moveTo(cx - val, 0);
                ctx.lineTo(cx + val, h);
            }
            ctx.stroke();
        }

        function drawTunnel(w, h, cx, cy) {
            for(let i=0; i<10; i++) {
                const val = dataArray[i*15] * 0.5;
                ctx.strokeStyle = varColor(0.4);
                ctx.beginPath();
                ctx.arc(cx, cy, i*40 + val, 0, Math.PI*2);
                ctx.stroke();
            }
        }

        function varColor(opacity) {
            return `rgba(0, 242, 255, ${opacity})`;
        }
    </script>
</body>
</html>
